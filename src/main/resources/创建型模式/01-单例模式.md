# å•ä¾‹æ¨¡å¼

## å‰è¨€

å•ä¾‹æ¨¡å¼å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼ŒåŸºæœ¬ä¸Šåšå¼€å‘çš„äººéƒ½çŸ¥é“æœ‰è¿™ä¸ªæ¨¡å¼ï¼Œç”¨é€”ä¹Ÿå¾ˆæ˜ç¡®ã€‚ä½†æ˜¯æ·±æŒ–ä¸€ä¸‹ï¼Œå°±ä¼šå‘ç°å¥½å¤šä¸œè¥¿ã€‚ä¸ªäººè®¤ä¸ºï¼Œå•ä¾‹æ¨¡å¼æ˜¯åˆ›å»ºå”¯ä¸€å¯¹è±¡å¹¶ä¸ºå…¶æä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•ã€‚

å•ä¾‹æ¨¡å¼æœ‰å››ç§ï¼šæ‡’æ±‰å¼å•ä¾‹ã€é¥¿æ±—å¼å•ä¾‹ã€é™æ€å†…éƒ¨ç±»å•ä¾‹ä»¥åŠæšä¸¾å¼å•ä¾‹ã€‚è¿™å››ç§å•ä¾‹æ¨¡å¼æ˜¯ä¸€æ­¥æ­¥è¿‡æ¸¡çš„ï¼Œæœ€å¼€å§‹æ˜¯æ‡’æ±‰å¼å’Œé¥¿æ±‰å¼ï¼Œä¸¤è€…ä¸€ä¸ªæ˜¯ç±»ä½¿ç”¨æ—¶åˆå§‹åŒ–ã€ä¸€ä¸ªæ˜¯ç±»åŠ è½½æ—¶ç›´æ¥åˆå§‹åŒ–å®ä¾‹ã€‚ç„¶åå°±æ˜¯é™æ€å†…éƒ¨ç±»å•ä¾‹ï¼Œåˆ©ç”¨é™æ€å†…éƒ¨ç±»çš„ç‰¹æ€§ä½¿å¾—å¤–éƒ¨ç±»ä½¿ç”¨æ—¶ä¸ä¼šåŠ è½½å†…éƒ¨ç±»ï¼Œè°ƒç”¨åˆ°å†…éƒ¨ç±»çš„æ—¶å€™æ‰ä¼šåŠ è½½å†…éƒ¨ç±»ï¼Œå°†æ‡’æ±—å¼å’Œé¥¿æ±‰å¼çš„ä¼˜ç‚¹ç»“åˆã€‚ä½†æ˜¯ä¸è®ºæ˜¯æ‡’æ±‰å¼ã€é¥¿æ±—å¼è¿˜æ˜¯é™æ€å†…éƒ¨ç±»éƒ½ä¼šè¢«åºåˆ—åŒ–åååºåˆ—åŒ–ä»¥åŠåå°„ç ´åå•ä¾‹ï¼Œæšä¸¾å¼å•ä¾‹åˆ™æ˜¯è§£å†³è¿™ä¸€é—®é¢˜çš„ç­”æ¡ˆã€‚

æ–‡ç« ä¸­å‡ºç°çš„ä»£ç ç”¨ä¾‹å¯ä»¥åˆ°[GitHub](https://github.com/nocoders/hello-design-pattern.git)ä¸ŠæŸ¥çœ‹

## å„ç±»å‹å•ä¾‹å®ç°

### æ‡’æ±‰å¼å•ä¾‹

æ‡’åŠ è½½ï¼Œå¯¹è±¡ä½¿ç”¨æ—¶å†å»åˆ›å»ºï¼Œç§æœ‰æ„é€ æ–¹æ³•å¹¶æä¾›ä¸€ä¸ªè¿”å›å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ï¼Œæ–¹æ³•ä¸­å¯¹å¯¹è±¡åŒé‡éç©ºåˆ¤æ–­å¹¶åŠ é”ä»¥åŠvolatileå…³é”®å­—ä¿®é¥°å¯¹è±¡ç¦æ­¢æŒ‡ä»¤é‡æ’ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚

#### å®ä¾‹

```java
/**
 * æ‡’æ±‰å¼å•ä¾‹ï¼šç§æœ‰æ„é€ æ–¹æ³•ï¼ŒåŒé‡éç©ºæ ¡éªŒï¼Œåˆ›å»ºå¯¹è±¡æ—¶åŠ é”ï¼Œvolatileå…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æ’ä¿è¯åˆ›å»ºå¯¹è±¡è¿™ä¸€æ­¥éª¤çš„çº¿ç¨‹å®‰å…¨
 *
 * @author linmeng
 * @version 1.0
 * @date 2022å¹´3æœˆ28æ—¥ 16:42
 */
public class LazySingleton implements Serializable {
    private static volatile LazySingleton lazySingleton;

    private LazySingleton() {
    }

    public static LazySingleton getInstance() {
        if (Objects.isNull(lazySingleton)) {
            synchronized (LazySingleton.class) {
                if (Objects.isNull(lazySingleton)) {
                    lazySingleton = new LazySingleton();
                }
            }
        }

        return lazySingleton;
    }
}

```

#### ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼šç±»åŠ è½½æ—¶ä¸å®ä¾‹åŒ–å¯¹è±¡ï¼Œä½¿ç”¨æ—¶æ‰å¯¹å¯¹è±¡è¿›è¡Œå®ä¾‹åŒ–ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—

ç¼ºç‚¹ï¼šä½¿ç”¨äº†åŒæ­¥é”ï¼Œå¯¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œåå°„ä»¥åŠåºåˆ—åŒ–åååºåˆ—åŒ–éƒ½èƒ½ç ´åå•ä¾‹

#### åŸç†

##### volatileå…³é”®å­—ä½œç”¨

jvmåˆ›å»ºå¯¹è±¡åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤

1. ä¸ºå¯¹è±¡åˆ†é…ç©ºé—´
2. åˆå§‹åŒ–å¯¹è±¡
3. å°†åˆå§‹åŒ–çš„å¯¹è±¡æŒ‡å‘åˆ†é…çš„ç©ºé—´

jvmåœ¨æ‰§è¡Œè¯­å¥æ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œæœ‰å¯èƒ½ä¸æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œã€‚è¿™æ—¶å€™ï¼Œä»£ç æ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ1 3 2.è¿™ä¸ªæ—¶å€™ä¸€ä¸ªçº¿ç¨‹èµ°åˆ°3é‚£ä¸€æ­¥ï¼Œä½†æ˜¯æ²¡æœ‰åˆå§‹åŒ–å¯¹è±¡ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åˆ¤æ–­éç©ºï¼Œå¯¹è±¡ä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›æœªåˆå§‹åŒ–çš„å¯¹è±¡è¿›è¡Œä½¿ç”¨ï¼Œè¿™å°±ä¼šé€ æˆç©ºæŒ‡é’ˆã€‚

ä½†æ˜¯ç”¨äº†volatileå…³é”®å­—ï¼Œç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œå°±ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚

### é¥¿æ±‰å¼å•ä¾‹

åœ¨ç¨‹åºåŠ è½½æ—¶åˆ›å»ºå¯¹è±¡ï¼Œè°ƒç”¨æ—¶ç›´æ¥è¿”å›

#### å®ä¾‹

```java
/**
 * é¥¿æ±‰å¼å•ä¾‹ï¼šstaticå…³é”®å­—ä½¿å¾—å˜é‡åœ¨ç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–ï¼Œfinalå…³é”®å­—ä½¿å¾—å˜é‡ä¸å¯è¢«ä¿®æ”¹
 * @author linmeng
 * @version 1.0
 * @date 2022å¹´3æœˆ28æ—¥ 16:55
 */
public class EagerSingleton implements Serializable {
    private static final EagerSingleton eagerSingleton = new EagerSingleton();

    private EagerSingleton(){}

    /**
     *
     * ç›´æ¥è¿”å›
     * @author linmeng
     * @date 2021å¹´11æœˆ9æ—¥ 21:44
     * @return com.sword.www.designPattern.singleton.EagerSingleton
     */
    public static EagerSingleton getInstance(){

        return eagerSingleton;
    }
}
```

#### ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼šä»£ç é€»è¾‘ç®€å•æ˜“æ‡‚

ç¼ºç‚¹ï¼šå ç”¨å†…å­˜ï¼Œåå°„ã€åºåˆ—åŒ–åååºåˆ—åŒ–éƒ½èƒ½ç ´åå•ä¾‹

### é™æ€å†…éƒ¨ç±»å•ä¾‹

ç§æœ‰æ„é€ æ–¹æ³•ï¼Œå®šä¹‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå†…éƒ¨ç±»ä¸­å£°æ˜å¯¹è±¡ï¼Œå†å®šä¹‰ä¸€ä¸ªè·å–å®ä¾‹çš„æ–¹æ³•è·å–å†…éƒ¨ç±»ä¸­çš„å®ä¾‹ã€‚

#### å®ä¾‹

```java
/**
 * é™æ€å†…éƒ¨ç±»å•ä¾‹ï¼šå¤–éƒ¨ç±»åŠ è½½æ—¶ä¸ä¼šåŠ è½½å†…éƒ¨ç±»ï¼Œåªæœ‰åœ¨ä½¿ç”¨åˆ°å†…éƒ¨ç±»çš„æ—¶å€™è™šæ‹Ÿæœºæ‰ä¼šåŠ è½½å†…éƒ¨ç±»
 * ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œå•ä¾‹çš„å”¯ä¸€æ€§ï¼Œå»¶è¿Ÿäº†ç±»çš„å®ä¾‹åŒ–
 * https://blog.csdn.net/mnb65482/article/details/80458571
 * https://juejin.cn/post/6871497501732519949
 *
 * @author linmeng
 * @version 1.0
 * @date 2022å¹´3æœˆ28æ—¥ 17:00
 */
public class StaticNestSingleton implements Serializable {

    private StaticNestSingleton() {
    }

    private static class SingletonHolder {
        private static final StaticNestSingleton SINGLETON = new StaticNestSingleton();
    }

    /**
     * ç›´æ¥è¿”å›
     *
     * @return com.sword.www.designPattern.singleton.EagerSingleton
     * @author linmeng
     * @date 2021å¹´11æœˆ9æ—¥ 21:44
     */
    public static StaticNestSingleton getInstance() {

        return SingletonHolder.SINGLETON;
    }
}
```

ä¼˜ç‚¹ï¼šåˆ©ç”¨è™šæ‹Ÿæœºçš„æœºåˆ¶ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚ç±»åŠ è½½æ—¶ä¸ä¼šåŠ è½½å†…éƒ¨ç±»ï¼Œä½¿ç”¨æ—¶æ‰ä¼šåŠ è½½ï¼Œç›¸å½“äºæ‡’æ±‰å¼å’Œé¥¿æ±‰å¼çš„ä¼˜ç‚¹ç»“åˆ

ç¼ºç‚¹ï¼šä¼šè¢«åºåˆ—åŒ–åååºåˆ—åŒ–ç ´åå•ä¾‹

### æšä¸¾å¼å•ä¾‹

ç›´æ¥å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»ã€‚

#### å®ä¾‹

```java
/**
 * https://www.cnblogs.com/happy4java/p/11206105.html
 * https://blog.csdn.net/weixin_48358336/article/details/120499442
 *
 * @author linmeng
 * @date 2022å¹´3æœˆ28æ—¥ 17:09
 * @return
 */
public enum EnumSingleton {
    INSTANCE;

    public void doSomething() {
        System.out.println("do something");
    }
}
```

#### ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼šä»£ç ç®€å•ï¼Œä¿è¯äº†åœ¨å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨æ€§ã€‚åˆ©ç”¨è™šæ‹Ÿæœºæœºåˆ¶é˜²æ­¢åå°„ã€åºåˆ—åŒ–åååºåˆ—åŒ–

ç¼ºç‚¹ï¼šå“ªæœ‰ä»€ä¹ˆç¼ºç‚¹

## å•ä¾‹ç ´å

ä½¿ç”¨ä¸€äº›ç‰¹æ®Šæ‰‹æ®µå¯ä»¥åŒæ—¶å®ä¾‹åŒ–å¤šä¸ªå•ä¾‹å¯¹è±¡ï¼Œè¿™æ ·å°±ç ´åäº†å•ä¾‹æ¨¡å¼ã€‚ç ´åå•ä¾‹çš„æ‰‹æ®µæœ‰è¿™å‡ ç§ï¼š

- å¤šçº¿ç¨‹ï¼šå¤šçº¿ç¨‹ä¸‹çœ‹è·å–åˆ°çš„å•ä¾‹å¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªï¼Œè¿™ä¸ªæ–‡ä¸­çš„å•ä¾‹ä»£ç å‡ä¸å—å…¶ç ´å
- åå°„ï¼šåå°„ä½¿ç”¨ç§æœ‰æ„é€ é™¤æšä¸¾å¼å•ä¾‹å¯ä»¥ä¸è¢«ç ´åï¼Œå…¶ä»–å•ä¾‹å‡éœ€è¦åœ¨ä»£ç å±‚é¢å¤„ç†
- åºåˆ—åŒ–åååºåˆ—åŒ–ï¼šå°†å¯¹è±¡åºåˆ—åŒ–æˆæ–‡ä»¶ï¼Œå†å¯¹å…¶ååºåˆ—åŒ–

#### å¤šçº¿ç¨‹ç ´å

ä½¿ç”¨CountDownLatchä½¿å¾—å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–å•ä¾‹å¯¹è±¡ï¼Œé€šè¿‡æ£€æŸ¥å¯¹è±¡åœ°å€åˆ¤æ–­æ˜¯å¦åˆ›å»ºäº†å¤šä¸ªå•ä¾‹å¯¹è±¡ä»è€Œç ´åå•ä¾‹

##### æµ‹è¯•ç”¨ä¾‹

```java
public void concurrentDestroy() throws InterruptedException, ExecutionException {
        // å®šé•¿çº¿ç¨‹æ± 
        ExecutorService executorService = Executors.newFixedThreadPool(5);
        // ä½¿å¾—å¤šä¸ªçº¿ç¨‹åŒä¸€æ—¶åˆ»å¯åŠ¨
        CountDownLatch countDownLatch = new CountDownLatch(5);
        // 1:é¥¿æ±‰å¼
        System.out.println("é¥¿æ±‰å¼åœ°å€æ‰“å°");
        List<Future<EagerSingleton>> eagerSingletonFutureList = new ArrayList<>();
        for (int i = 0; i < 5; i++) {
            Future<EagerSingleton> future = executorService.submit(() -> {
                countDownLatch.countDown();
                return EagerSingleton.getInstance();
            });
            eagerSingletonFutureList.add(future);
        }
        countDownLatch.await();
        // å¯¹è±¡åœ°å€æ‰“å°
        print(eagerSingletonFutureList);
        // 2:æ‡’æ±‰å¼
        System.out.println("æ‡’æ±‰å¼åœ°å€æ‰“å°");
        List<Future<LazySingleton>> lazySingletonFutureList = new ArrayList<>();
        CountDownLatch countDownLatch1 = new CountDownLatch(5);
        for (int i = 0; i < 5; i++) {
            Future<LazySingleton> future = executorService.submit(() -> {
                countDownLatch1.countDown();
                return LazySingleton.getInstance();
            });
            lazySingletonFutureList.add(future);
        }
        countDownLatch1.await();
        // å¯¹è±¡åœ°å€æ‰“å°
        print(lazySingletonFutureList);
        // 3:å†…éƒ¨ç±»
        System.out.println("å†…éƒ¨ç±»åœ°å€æ‰“å°");
        List<Future<StaticNestSingleton>> staticNestSingletonFutureList = new ArrayList<>();
        CountDownLatch countDownLatch2 = new CountDownLatch(5);
        for (int i = 0; i < 5; i++) {
            Future<StaticNestSingleton> future = executorService.submit(() -> {
                countDownLatch2.countDown();
                return StaticNestSingleton.getInstance();
            });
            staticNestSingletonFutureList.add(future);
        }
        countDownLatch2.await();
        // å¯¹è±¡åœ°å€æ‰“å°
        print(staticNestSingletonFutureList);
        // 4:æšä¸¾
        System.out.println("æšä¸¾ç›¸ç­‰åˆ¤æ–­");
        List<Future<EnumSingleton>> enumSingletonFutureList = new ArrayList<>();
        CountDownLatch countDownLatch3 = new CountDownLatch(5);
        for (int i = 0; i < 5; i++) {
            Future<EnumSingleton> future = executorService.submit(() -> {
                countDownLatch3.countDown();
                return EnumSingleton.INSTANCE;
            });
            enumSingletonFutureList.add(future);
        }
        countDownLatch3.await();
        // å¯¹è±¡åœ°å€åˆ¤æ–­
        System.out.println((enumSingletonFutureList.get(0).get()==enumSingletonFutureList.get(1).get())&&
                (enumSingletonFutureList.get(0).get()==enumSingletonFutureList.get(1).get()) &&
                (enumSingletonFutureList.get(1).get()==enumSingletonFutureList.get(2).get()) &&
                (enumSingletonFutureList.get(2).get()==enumSingletonFutureList.get(3).get()) &&
                (enumSingletonFutureList.get(3).get()==enumSingletonFutureList.get(4).get()));
    }
 /**
     * æ‰“å°å¯¹è±¡
     * @param list
     * @param <T>
     */
    <T> void print(List<Future<T>> list){
        list.forEach(s ->{
            try {
                System.out.println(s.get().toString());
            } catch (InterruptedException | ExecutionException e) {
                e.printStackTrace();
            }
        });
    }
```

##### æ‰“å°ç»“æœ

```
é¥¿æ±‰å¼åœ°å€æ‰“å°
com.hello.designPattern.SingletonPattern.EagerSingleton@1e81f4dc
com.hello.designPattern.SingletonPattern.EagerSingleton@1e81f4dc
com.hello.designPattern.SingletonPattern.EagerSingleton@1e81f4dc
com.hello.designPattern.SingletonPattern.EagerSingleton@1e81f4dc
com.hello.designPattern.SingletonPattern.EagerSingleton@1e81f4dc
æ‡’æ±‰å¼åœ°å€æ‰“å°
com.hello.designPattern.SingletonPattern.LazySingleton@48cf768c
com.hello.designPattern.SingletonPattern.LazySingleton@48cf768c
com.hello.designPattern.SingletonPattern.LazySingleton@48cf768c
com.hello.designPattern.SingletonPattern.LazySingleton@48cf768c
com.hello.designPattern.SingletonPattern.LazySingleton@48cf768c
å†…éƒ¨ç±»åœ°å€æ‰“å°
com.hello.designPattern.SingletonPattern.StaticNestSingleton@4aa8f0b4
com.hello.designPattern.SingletonPattern.StaticNestSingleton@4aa8f0b4
com.hello.designPattern.SingletonPattern.StaticNestSingleton@4aa8f0b4
com.hello.designPattern.SingletonPattern.StaticNestSingleton@4aa8f0b4
com.hello.designPattern.SingletonPattern.StaticNestSingleton@4aa8f0b4
æšä¸¾ç›¸ç­‰åˆ¤æ–­
true
```

ä»ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¹¶å‘æƒ…å†µä¸‹ï¼Œä¸Šé¢å„ä¸ªç±»å‹çš„å•ä¾‹éƒ½å¯ä»¥è¿”å›ç›¸åŒçš„å¯¹è±¡å®ä¾‹ã€‚æ€»è€Œè¨€ä¹‹ï¼Œå¹¶å‘å¯¹æ–‡ä¸­ç¼–å†™çš„å•ä¾‹ç¤ºä¾‹æ— ç ´åã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹åå°„å¯¹å•ä¾‹æ˜¯å¦æœ‰ç ´å

#### åå°„ç ´å

##### æµ‹è¯•ç”¨ä¾‹

```java
 /**
     * åå°„å•ä¾‹ç ´å
     * https://blog.csdn.net/liuyingming910/article/details/42457265
     * @author linmeng
     * @date 2022å¹´3æœˆ29æ—¥ 11:13
     * @return void
     */
    @Test
    public void reflectDestroy() throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        System.out.println("é¥¿æ±‰å¼å•ä¾‹åå°„æµ‹è¯•");
        EagerSingleton eagerSingleton1 = EagerSingleton.getInstance();
        Constructor<EagerSingleton> declaredConstructor = EagerSingleton.class.getDeclaredConstructor();
        declaredConstructor.setAccessible(true);
        EagerSingleton eagerSingleton = declaredConstructor.newInstance();
        System.out.println(eagerSingleton);
        System.out.println(eagerSingleton1);
        System.out.println(eagerSingleton == eagerSingleton1);
        System.out.println("æ‡’æ±‰å¼å•ä¾‹åå°„æµ‹è¯•");
        LazySingleton lazySingleton1 = LazySingleton.getInstance();
        Constructor<LazySingleton> lazySingletonConstructor = LazySingleton.class.getDeclaredConstructor();
        lazySingletonConstructor.setAccessible(true);
        LazySingleton lazySingleton = lazySingletonConstructor.newInstance();
        System.out.println(lazySingleton1);
        System.out.println(lazySingleton);
        System.out.println(lazySingleton1 == lazySingleton);
        System.out.println("å†…éƒ¨ç±»å•ä¾‹æµ‹è¯•");
        Class<StaticNestSingleton> staticNestSingletonClass = StaticNestSingleton.class;
        Constructor<StaticNestSingleton> staticNestSingletonConstructor = staticNestSingletonClass.getDeclaredConstructor();
        staticNestSingletonConstructor.setAccessible(true);
        StaticNestSingleton staticNestSingleton = staticNestSingletonConstructor.newInstance();
        StaticNestSingleton staticNestSingleton1 = StaticNestSingleton.getInstance();
        System.out.println(staticNestSingleton);
        System.out.println(staticNestSingleton1);
        System.out.println(staticNestSingleton1 == staticNestSingleton);

       System.out.println("æšä¸¾å•ä¾‹æµ‹è¯•");
        EnumSingleton enumSingleton = EnumSingleton.INSTANCE;
        Constructor<?>[] declaredConstructors = EnumSingleton.class.getDeclaredConstructors();
        for (Constructor<?> constructor : declaredConstructors) {
            System.out.println(constructor);
        }
        Constructor<?> enumSingletonConstructor = declaredConstructors[0];

//        System.out.println(enumSingletonConstructor);
        enumSingletonConstructor.setAccessible(true);
        Object enumSingleton1 = enumSingletonConstructor.newInstance("INSTANCE",0);
        System.out.println(enumSingleton == enumSingleton1);
    }
```

##### æ‰“å°ç»“æœ

```
é¥¿æ±‰å¼å•ä¾‹åå°„æµ‹è¯•
com.hello.designPattern.SingletonPattern.EagerSingleton@78e03bb5
com.hello.designPattern.SingletonPattern.EagerSingleton@5e8c92f4
false
æ‡’æ±‰å¼å•ä¾‹åå°„æµ‹è¯•
com.hello.designPattern.SingletonPattern.LazySingleton@61e4705b
com.hello.designPattern.SingletonPattern.LazySingleton@50134894
false
å†…éƒ¨ç±»å•ä¾‹æµ‹è¯•
com.hello.designPattern.SingletonPattern.StaticNestSingleton@2957fcb0
com.hello.designPattern.SingletonPattern.StaticNestSingleton@1376c05c
false
æšä¸¾å•ä¾‹æµ‹è¯•

æšä¸¾å•ä¾‹æµ‹è¯•
private com.hello.designPattern.SingletonPattern.EnumSingleton(java.lang.String,int)

java.lang.IllegalArgumentException: Cannot reflectively create enum objects

	at java.lang.reflect.Constructor.newInstance(Constructor.java:417)
	at com.hello.designPattern.singletonPattern.SingletonTest.reflectDestroy(SingletonTest.java:146)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)
	at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:235)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:54)

```

ä¸ç®¡æ˜¯é¥¿æ±‰å¼ã€æ‡’æ±‰å¼è¿˜æ˜¯é™æ€å†…éƒ¨ç±»ï¼Œåå°„éƒ½èƒ½å¤Ÿç ´åå…¶å•ä¾‹å¯¹è±¡çš„å”¯ä¸€æ€§ï¼Œåªæœ‰æšä¸¾å¼è§£å†³äº†åå°„ç ´åã€‚

#### åºåˆ—åŒ–ç ´å

è¿™é‡Œæˆ‘ä½¿ç”¨äº†common-lang3æä¾›çš„åºåˆ—åŒ–å·¥å…·ç±»SerializationUtilsï¼Œä¾èµ–å¦‚ä¸‹ï¼š

```
<dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
            <version>3.12.0</version>
        </dependency>
```

##### æµ‹è¯•ç”¨ä¾‹

```java
 @Test
    public void serializeDestroy(){
        System.out.println("é¥¿æ±‰å¼æ¨¡å¼");
        EagerSingleton eagerSingleton = EagerSingleton.getInstance();
        EagerSingleton deserializeEagerSingleton = serializeAndDeserialize(eagerSingleton);
        System.out.println(eagerSingleton);
        System.out.println(deserializeEagerSingleton);
        System.out.println("æ‡’æ±‰å¼æ¨¡å¼");
        LazySingleton lazySingleton = LazySingleton.getInstance();
        LazySingleton deserializeLazySingleton = serializeAndDeserialize(lazySingleton);
        System.out.println(lazySingleton);
        System.out.println(deserializeLazySingleton);
        System.out.println("å†…éƒ¨ç±»æ¨¡å¼");
        StaticNestSingleton staticNestSingleton = StaticNestSingleton.getInstance();
        StaticNestSingleton serializeAndDeserializeStaticNestSingleton = serializeAndDeserialize(staticNestSingleton);
        System.out.println(staticNestSingleton);
        System.out.println(serializeAndDeserializeStaticNestSingleton);
        System.out.println("æšä¸¾å¼å•ä¾‹");
        EnumSingleton enumSingleton = EnumSingleton.INSTANCE;
        EnumSingleton serializeAndDeserializeEnumSingleton = serializeAndDeserialize(enumSingleton);
        System.out.println(enumSingleton == serializeAndDeserializeEnumSingleton);
    }

    private <T extends Serializable> T serializeAndDeserialize(T singleton) {
        byte[] eagerSingletonSerializeBytes = SerializationUtils.serialize(singleton);
        return SerializationUtils.deserialize(eagerSingletonSerializeBytes);
    }
```

##### æ‰“å°ç»“æœ

```
é¥¿æ±‰å¼æ¨¡å¼
com.hello.designPattern.SingletonPattern.EagerSingleton@65ae6ba4
com.hello.designPattern.SingletonPattern.EagerSingleton@3b192d32
æ‡’æ±‰å¼æ¨¡å¼
com.hello.designPattern.SingletonPattern.LazySingleton@ed17bee
com.hello.designPattern.SingletonPattern.LazySingleton@2a33fae0
å†…éƒ¨ç±»æ¨¡å¼
com.hello.designPattern.SingletonPattern.StaticNestSingleton@21588809
com.hello.designPattern.SingletonPattern.StaticNestSingleton@2aae9190
æšä¸¾å¼å•ä¾‹
true
```

åŒåå°„ç ´åä¸€æ ·ï¼Œä¹Ÿæ˜¯åªæœ‰æšä¸¾å¼å•ä¾‹ä¸è¢«ç ´å

#### æšä¸¾ç±»å•ä¾‹å®‰å…¨åŸå› 

åœ¨ä»£ç å±‚é¢ä¸Šï¼Œæˆ‘æ²¡æœ‰å¯¹æšä¸¾å¼å•ä¾‹åšä»»ä½•å¤„ç†ï¼Œé‚£ä»–ä¸è¢«ç ´åçš„åŸå› è‚¯å®šæ˜¯jdkçš„å†…éƒ¨æœºåˆ¶ã€‚

##### å¹¶å‘å®‰å…¨åŸå› 

å¯¹æšä¸¾å¼å•ä¾‹classæ–‡ä»¶è¿›è¡Œåç¼–è¯‘,åç¼–è¯‘åä»£ç å¦‚ä¸‹

```
//  javap -c EnumSingleton.class 
public final class com.hello.designPattern.SingletonPattern.EnumSingleton extends java.lang.Enum<com.hello.designPattern.SingletonPattern.EnumSingleton> {
  public static final com.hello.designPattern.SingletonPattern.EnumSingleton INSTANCE;

  public static com.hello.designPattern.SingletonPattern.EnumSingleton[] values();
    Code:
       0: getstatic     #1                  // Field $VALUES:[Lcom/hello/designPattern/SingletonPattern/EnumSingleton;
       3: invokevirtual #2                  // Method "[Lcom/hello/designPattern/SingletonPattern/EnumSingleton;".clone:()Ljava/lang/Object;
       6: checkcast     #3                  // class "[Lcom/hello/designPattern/SingletonPattern/EnumSingleton;"
       9: areturn

  public static com.hello.designPattern.SingletonPattern.EnumSingleton valueOf(java.lang.String);
    Code:
       0: ldc           #4                  // class com/hello/designPattern/SingletonPattern/EnumSingleton
       2: aload_0
       3: invokestatic  #5                  // Method java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;
       6: checkcast     #4                  // class com/hello/designPattern/SingletonPattern/EnumSingleton
       9: areturn

  public void doSomething();
    Code:
       0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
       3: ldc           #8                  // String do something
       5: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
       8: return

  static {};
    Code:
       0: new           #4                  // class com/hello/designPattern/SingletonPattern/EnumSingleton
       3: dup
       4: ldc           #10                 // String INSTANCE
       6: iconst_0
       7: invokespecial #11                 // Method "<init>":(Ljava/lang/String;I)V
      10: putstatic     #12                 // Field INSTANCE:Lcom/hello/designPattern/SingletonPattern/EnumSingleton;
      13: iconst_1
      14: anewarray     #4                  // class com/hello/designPattern/SingletonPattern/EnumSingleton
      17: dup
      18: iconst_0
      19: getstatic     #12                 // Field INSTANCE:Lcom/hello/designPattern/SingletonPattern/EnumSingleton;
      22: aastore
      23: putstatic     #1                  // Field $VALUES:[Lcom/hello/designPattern/SingletonPattern/EnumSingleton;
      26: return
}

```

è¯´å®è¯ï¼Œåç¼–è¯‘åçš„ä»£ç ï¼Œæˆ‘ä¹Ÿçœ‹ä¸å¤ªæ‡‚ï¼Œä¸è¿‡å…³é”®å­—è¿˜æ˜¯å¯ä»¥çœ‹æ‡‚çš„ï¼Œå˜é‡INSTANCEè¢«static finalä¿®é¥°ï¼Œstaticå…³é”®å­—ä½¿å¾—å…¶åœ¨ç±»åŠ è½½æ—¶å°±è¢«åˆå§‹åŒ–ï¼Œfinalå…³é”®å­—ä½¿å¾—å…¶ä¸å¯è¢«ä¿®æ”¹ï¼Œä¿è¯å¹¶å‘å®‰å…¨ã€‚

##### åå°„å®‰å…¨åŸå› 

åå°„è·å–å¯¹è±¡æ—¶æ˜¯ä½¿ç”¨çš„æ˜¯enumSingletonConstructor.newInstance("INSTANCE",0)æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹æ–¹æ³•æºç ï¼Œåªæˆªå–åˆ¤æ–­çš„éƒ¨åˆ†

```
if ((clazz.getModifiers() & Modifier.ENUM) != 0)
            throw new IllegalArgumentException("Cannot reflectively create enum objects");
```

è·å–å®ä¾‹å‰ä¼šåˆ¤æ–­classå¯¹è±¡æ˜¯ä¸æ˜¯æšä¸¾ï¼Œå¦‚æœæ˜¯æšä¸¾çš„è¯ï¼Œç›´æ¥æŠ›å¼‚å¸¸ã€‚

#### åºåˆ—åŒ–å®‰å…¨åŸå› 

æšä¸¾çš„ååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯Enumä¸­çš„valueOfæ–¹æ³•è·å–çš„å¯¹è±¡ï¼Œå®é™…ä¸Šè¿˜æ˜¯ç”¨çš„åå°„è·å–æ‰€æœ‰çš„æšä¸¾å¯¹è±¡ï¼Œç„¶åè·å–å¯¹åº”çš„æšä¸¾å®ä¾‹

```
public static <T extends Enum<T>> T valueOf(Class<T> enumType,
                                                String name) {
        T result = enumType.enumConstantDirectory().get(name);
        if (result != null)
            return result;
        if (name == null)
            throw new NullPointerException("Name is null");
        throw new IllegalArgumentException(
            "No enum constant " + enumType.getCanonicalName() + "." + name);
    }
 Map<String, T> enumConstantDirectory() {
        if (enumConstantDirectory == null) {
        // åå°„è°ƒç”¨valuesæ–¹æ³•è·å–æ‰€æœ‰çš„ç¾å‰§
            T[] universe = getEnumConstantsShared();
            if (universe == null)
                throw new IllegalArgumentException(
                    getName() + " is not an enum type");
            Map<String, T> m = new HashMap<>(2 * universe.length);
            // å°†è·å–åˆ°çš„æ‰€æœ‰æšä¸¾ä»¥åç§°ä¸ºkeyï¼Œæšä¸¾å¯¹è±¡ä¸ºvalueæ”¾åˆ°mapä¸­å»
            for (T constant : universe)
                m.put(((Enum<?>)constant).name(), constant);
            enumConstantDirectory = m;
        }
        return enumConstantDirectory;
    }
    private volatile transient Map<String, T> enumConstantDirectory = null;

```

## å•ä¾‹ç ´åé—®é¢˜è§£å†³

### åå°„ç ´åé—®é¢˜è§£å†³

åå°„è·å–å¯¹è±¡æ—¶ï¼Œæ˜¯ç›´æ¥è°ƒç”¨å…¶ç§æœ‰æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æ„é€ æ–¹æ³•ä¸­åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºç›´æ¥æŠ›å¼‚å¸¸ã€‚é™æ€å†…éƒ¨ç±»è¿™ä¸ªä¸çŸ¥é“æ€ä¹ˆå¼„ï¼Œæœ‰çŸ¥é“çš„å°ä¼™ä¼´å¯ä»¥å‘Šè¯‰ä¸€ä¸‹ï¼Œè·ªæ±‚ğŸ˜ƒã€‚

```java
		// é¥¿æ±‰å¼
    private EagerSingleton() {
        if (eagerSingleton !=null){
            throw new RuntimeException();
        }
    }
    //æ‡’æ±‰å¼
     private LazySingleton() {
        if (lazySingleton != null) {
            throw new RuntimeException();
        }
    }
```

### åºåˆ—åŒ–ç ´åé—®é¢˜è§£å†³

ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­ç±»ä¸­æœ‰æ²¡æœ‰readResolveæ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œç›´æ¥ä½¿ç”¨è¯¥æ–¹æ³•è·å–è¿”å›å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç±»ä¸­è‡ªå®šä¹‰è¯¥æ–¹æ³•ã€‚

```java
public Object readResolve(){
        return eagerSingleton;
    }
public Object readResolve(){
        return lazySingleton;
    }
public Object readResolve(){
        return SingletonHolder.SINGLETON;
    }
```

## å»ºè®®

ç›´æ¥ä½¿ç”¨æšä¸¾å¼å•ä¾‹ï¼Œæ— éœ€ä»»ä½•é¢å¤–ä»£ç å¤„ç†ï¼Œç®€å•é«˜æ•ˆã€‚

## å‚è€ƒé“¾æ¥

[å‘½ä»¤è¡Œä¸­ javacã€javaã€javap çš„ä½¿ç”¨è¯¦è§£](https://blog.csdn.net/zhouxukun123/article/details/79121059)

[æ·±åº¦åˆ†æJavaçš„æšä¸¾ç±»å‹â€”-æšä¸¾çš„çº¿ç¨‹å®‰å…¨æ€§åŠåºåˆ—åŒ–é—®é¢˜ ](https://www.cnblogs.com/z00377750/p/9177097.html)